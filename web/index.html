<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="×©×›×•× ×ª×™ - ×”××¤×œ×™×§×¦×™×” ×©××—×‘×¨×ª ×‘×™×Ÿ ×©×›× ×™× ×œ×¢×–×¨×” ×”×“×“×™×ª. ×‘×§×©×•×ª ×¢×–×¨×” ××§×•××™×•×ª, ×¢×–×¨×” ×”×“×“×™×ª ×‘×©×›×•× ×” ×•×—×™×‘×•×¨ ×‘×™×Ÿ ×©×›× ×™×.">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="×©×›×•× ×ª×™">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>×©×›×•× ×ª×™ - ×¢×–×¨×” ×”×“×“×™×ª ×‘×©×›×•× ×”</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- Google Sign-In Configuration -->
  <meta name="google-signin-client_id" content="725875446445-jlfrijsk12skri7j948on9c1jflksee4.apps.googleusercontent.com">
  <meta name="google-signin-redirect_uri" content="https://nearme-970f3.web.app">
  
  <!-- Google Maps JavaScript API -->
  <!-- Load synchronously in head to ensure it's available before Flutter -->
  <!-- Using Browser key (auto created by Firebase) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAGALOMmVVNl1f_xYDRXoFrgX_Z0B5HjQQ&libraries=places&callback=initGoogleMaps"></script>
  <script>
    // Global flag to track Google Maps API loading
    window.googleMapsReady = false;
    window.googleMapsError = null;
    
    // Alternative loading method (if script tag above doesn't work)
    (function() {
      console.log('ğŸ—ºï¸ Setting up Google Maps API...');
      
      // Check if already loaded
      if (typeof google !== 'undefined' && google.maps) {
        console.log('âœ… Google Maps API already loaded');
        window.googleMapsReady = true;
        return;
      }
      
      // Fallback: Load dynamically if not already loaded
      setTimeout(function() {
        if (typeof google === 'undefined' || !google.maps) {
          console.log('ğŸ”„ Google Maps API not loaded yet, trying dynamic load...');
          const script = document.createElement('script');
          script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyAGALOMmVVNl1f_xYDRXoFrgX_Z0B5HjQQ&libraries=places&callback=initGoogleMaps';
          script.async = true;
          script.defer = true;
          script.onerror = function(e) {
            console.error('âŒ Failed to load Google Maps API script:', e);
            window.googleMapsError = 'Failed to load Google Maps API script. Please check: 1) API key is valid, 2) API key is enabled for Web applications, 3) Maps JavaScript API is enabled in Google Cloud Console';
            // Still try to load Flutter after delay
            setTimeout(function() {
              if (!window.googleMapsReady) {
                console.warn('âš ï¸ Google Maps API failed to load, but continuing with Flutter');
              }
            }, 3000);
          };
          script.onload = function() {
            console.log('ğŸ“¦ Google Maps API script loaded (but callback may not have fired yet)');
          };
          document.head.appendChild(script);
        }
      }, 500);
    })();
    
    // Initialize Google Maps when API is loaded
    window.initGoogleMaps = function() {
      console.log('âœ… Google Maps API callback called');
      try {
        // Small delay to ensure everything is initialized
        setTimeout(function() {
          try {
            // Ensure google.maps is available
            if (typeof google !== 'undefined' && google.maps) {
              console.log('âœ… google.maps object is available');
              
              // Check for Google Maps authentication errors
              if (google.maps.Error) {
                console.log('âœ… Google Maps Error handler is available');
              }
              
              // Try to create a test map to verify API key works
              try {
                const testDiv = document.createElement('div');
                testDiv.style.display = 'none';
                document.body.appendChild(testDiv);
                
                const testMap = new google.maps.Map(testDiv, {
                  center: { lat: 31.7683, lng: 35.2137 },
                  zoom: 10,
                  disableDefaultUI: true
                });
                
                // Check if map was created successfully
                if (testMap) {
                  console.log('âœ… Test map created successfully - API key is valid');
                  document.body.removeChild(testDiv);
                }
              } catch (mapError) {
                console.error('âŒ Failed to create test map:', mapError);
                console.error('   This usually means: 1) API key is invalid, 2) Maps JavaScript API is not enabled, 3) API key restrictions are blocking this domain');
                window.googleMapsError = 'Failed to create test map: ' + mapError.toString();
              }
              
              // Polyfill for MapTypeId if needed
              if (!google.maps.MapTypeId) {
                console.warn('âš ï¸ MapTypeId not found, creating polyfill');
                google.maps.MapTypeId = {
                  ROADMAP: 'roadmap',
                  SATELLITE: 'satellite',
                  HYBRID: 'hybrid',
                  TERRAIN: 'terrain'
                };
              } else {
                console.log('âœ… MapTypeId is available:', Object.keys(google.maps.MapTypeId));
              }
              
              window.googleMapsReady = true;
              console.log('âœ… Google Maps API is fully ready');
              
              // Trigger any waiting callbacks
              if (window.onGoogleMapsReady) {
                window.onGoogleMapsReady();
              }
            } else {
              console.error('âŒ google.maps is not available after API load');
              console.error('   typeof google:', typeof google);
              console.error('   google.maps:', typeof google !== 'undefined' ? google.maps : 'N/A');
              console.error('   Current URL:', window.location.href);
              console.error('   API Key used: AIzaSyAGALOMmVVNl1f_xYDRXoFrgX_Z0B5HjQQ');
              window.googleMapsError = 'google.maps object not available. This usually means: 1) API key is invalid, 2) API key restrictions are too strict, 3) Maps JavaScript API is not enabled';
            }
          } catch (e) {
            console.error('âŒ Error checking google.maps:', e);
            console.error('   Error stack:', e.stack);
            window.googleMapsError = e.toString();
          }
        }, 100);
      } catch (e) {
        console.error('âŒ Error in initGoogleMaps:', e);
        console.error('   Error stack:', e.stack);
        window.googleMapsError = e.toString();
      }
    };
    
    // Fallback initialization
    window.initMap = function() {
      console.log('ğŸ“ initMap callback called (fallback)');
      window.initGoogleMaps();
    };
    
    // Polyfill for Intl.Segmenter to fix deprecation warning
    if (!window.Intl.Segmenter) {
      console.log('Intl.Segmenter not available, using fallback');
      // This is just to suppress the warning - the app will still work
    }
    
           // Enhanced error handling for uncaught errors
           let errorCount = 0;
           const maxErrors = 10; // ×”×’×‘×œ×ª ××¡×¤×¨ ×”×©×’×™××•×ª
           
           window.addEventListener('error', function(e) {
             errorCount++;
             
             // ×× ×™×© ×™×•×ª×¨ ××“×™ ×©×’×™××•×ª, ×¢×¦×•×¨ ×”×›×œ
             if (errorCount > maxErrors) {
               console.warn('Too many errors detected, stopping error handling to prevent infinite loop');
               return true;
             }
             
             // ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×¡×¤×¦×™×¤×™×•×ª
             if (e.error && e.error.toString().includes('Cross-Origin-Opener-Policy')) {
               console.warn('Cross-Origin-Opener-Policy error detected, this is expected with popups');
               e.preventDefault();
               return true;
             }
             
             if (e.message && e.message.includes('CORS policy')) {
               console.warn('CORS error detected, this may be due to Firebase Storage rules');
               e.preventDefault();
               return true;
             }
             
             if (e.error && e.error.toString().includes('minified')) {
               console.warn('Minified error detected, this is a known issue with Flutter Web');
               e.preventDefault();
               return true;
             }
             
             // ×˜×™×¤×•×œ ×‘×©×’×™××•×ª Null check operator
             if (e.error && e.error.toString().includes('Null check operator')) {
               console.warn('Null check operator error detected, this is a known Flutter Web issue');
               e.preventDefault();
               return true;
             }
             
             // ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×›×œ×œ×™×•×ª
             console.warn('Uncaught error:', e.error);
             e.preventDefault();
             return true;
           });
    
    window.addEventListener('unhandledrejection', function(e) {
      errorCount++;
      
      // ×× ×™×© ×™×•×ª×¨ ××“×™ ×©×’×™××•×ª, ×¢×¦×•×¨ ×”×›×œ
      if (errorCount > maxErrors) {
        console.warn('Too many promise rejections detected, stopping error handling to prevent infinite loop');
        return true;
      }
      
      console.warn('Unhandled promise rejection:', e.reason);
      e.preventDefault();
    });
    
    // Global error handler for Flutter
    window.addEventListener('flutter-error', function(e) {
      console.warn('Flutter error:', e.detail);
    });
    
    // Listen for Google Maps specific errors
    window.addEventListener('gm_authFailure', function() {
      console.error('âŒ Google Maps Authentication Error!');
      console.error('   This means the API key is invalid or not authorized for this domain.');
      console.error('   Please check:');
      console.error('   1. API key is correct: AIzaSyAGALOMmVVNl1f_xYDRXoFrgX_Z0B5HjQQ');
      console.error('   2. Maps JavaScript API is enabled in Google Cloud Console');
      console.error('   3. API key restrictions allow this domain: ' + window.location.hostname);
      console.error('   4. For localhost, add "localhost" or "localhost:*" to allowed referrers');
      console.error('   5. For Firebase hosting, add "*.web.app" and "*.firebaseapp.com" to allowed referrers');
      window.googleMapsError = 'Google Maps Authentication Error - API key is invalid or not authorized';
    });
    
    // Initialize app with error handling
    window.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing app...');
      
      // Handle payment success callback - CHECK FIRST
      if (window.location.pathname === '/payment/success' || window.location.pathname.includes('payment/success')) {
        console.log('Payment success callback detected - opening app');
        
        // Show custom message
        document.body.innerHTML = '';
        document.body.style.margin = '0';
        document.body.style.padding = '0';
        document.body.innerHTML = `
          <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f5f5f5; font-family: Arial, sans-serif; direction: rtl;">
            <div style="background-color: white; padding: 40px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 500px; text-align: center;">
              <h1 style="color: #2c3e50; margin-bottom: 20px; font-size: 24px;">âœ… ×ª×©×œ×•× ××•×©×¨</h1>
              <p style="color: #666; font-size: 16px; line-height: 1.6; margin-bottom: 30px;">×”×ª×©×œ×•× ×©×œ×š ××•×©×¨ ×‘×”×¦×œ×—×”! ×”×× ×•×™ ×©×œ×š ×”×•×¤×¢×œ.</p>
              <p style="color: #999; font-size: 12px; margin-top: 30px;">×¤×ª×™×—×ª ×”××¤×œ×™×§×¦×™×”...</p>
            </div>
          </div>
        `;
        
        // Try to open app if on mobile
        if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
          // Try multiple deep link schemes
          setTimeout(function() {
            window.location.href = 'shchunati://payment/success';
          }, 500);
          setTimeout(function() {
            window.location.href = 'com.example.flutter1://payment/success';
          }, 1500);
        }
        return; // Don't continue to email verification check
      }
      
      // Handle email verification callback
      if (window.location.pathname === '/email-verified' || window.location.pathname.includes('email-verified') || window.location.search.includes('email-verified')) {
        console.log('Email verification callback detected - showing custom page');
        // Extract message from URL
        const urlParams = new URLSearchParams(window.location.search);
        const message = urlParams.get('message') || '×”××™××™×™×œ ×©×œ×š ××•××ª. ×”×ª×—×‘×¨ ×©×•×‘ ×œ×©×›×•× ×ª×™ ×¢× ×”×¤×¨×˜×™× ×©× ×¨×©××ª ×‘×”×.';
        const email = urlParams.get('email');
        
        // Show custom message IMMEDIATELY - replace entire page
        document.body.innerHTML = '';
        document.body.style.margin = '0';
        document.body.style.padding = '0';
        document.body.innerHTML = `
          <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f5f5f5; font-family: Arial, sans-serif; direction: rtl;">
            <div style="background-color: white; padding: 40px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 500px; text-align: center;">
              <h1 style="color: #2c3e50; margin-bottom: 20px; font-size: 24px;">âœ… ×”××™××™×™×œ ×©×œ×š ××•××ª</h1>
              <p style="color: #666; font-size: 16px; line-height: 1.6; margin-bottom: 30px;">${message}</p>
              ${email ? `<p style="color: #999; font-size: 14px; margin-top: 20px;">××™××™×™×œ: ${email}</p>` : ''}
              <p style="color: #999; font-size: 12px; margin-top: 30px;">×ª×•×›×œ ×œ×¡×’×•×¨ ××ª ×”×—×œ×•×Ÿ ×”×–×” ×•×œ×—×–×•×¨ ×œ××¤×œ×™×§×¦×™×”.</p>
            </div>
          </div>
        `;
        
        // Try to open app if on mobile
        if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
          setTimeout(function() {
            window.location.href = 'com.example.flutter1://email-verified';
          }, 2000);
        }
        
        // Stop here - don't load Flutter
        return;
      }
      
      // Wait for Google Maps API to be ready before Flutter bootstrap
      function waitForGoogleMaps(callback, maxAttempts = 100) {
        let attempts = 0;
        const checkInterval = setInterval(function() {
          attempts++;
          if (window.googleMapsReady && typeof google !== 'undefined' && google.maps && google.maps.MapTypeId) {
            console.log('âœ… Google Maps API is ready (attempt ' + attempts + ')');
            clearInterval(checkInterval);
            callback();
          } else if (attempts >= maxAttempts) {
            console.warn('âš ï¸ Google Maps API not loaded after ' + maxAttempts + ' attempts (' + (maxAttempts * 0.1) + ' seconds), proceeding anyway');
            console.warn('   googleMapsReady:', window.googleMapsReady);
            console.warn('   google defined:', typeof google !== 'undefined');
            console.warn('   google.maps defined:', typeof google !== 'undefined' && google.maps);
            console.warn('   MapTypeId defined:', typeof google !== 'undefined' && google.maps && google.maps.MapTypeId);
            if (window.googleMapsError) {
              console.warn('   Error:', window.googleMapsError);
            }
            clearInterval(checkInterval);
            callback();
          }
        }, 100);
      }
      
      // Set up callback for when Google Maps is ready
      window.onGoogleMapsReady = function() {
        console.log('ğŸ“ onGoogleMapsReady callback triggered');
      };
      
      // Flag to prevent double loading
      let flutterLoaded = false;
      
      function loadFlutterBootstrap() {
        if (flutterLoaded) return;
        flutterLoaded = true;
        console.log('ğŸš€ Loading Flutter bootstrap');
        const flutterScript = document.createElement('script');
        flutterScript.src = 'flutter_bootstrap.js';
        flutterScript.async = true;
        document.body.appendChild(flutterScript);
      }
      
      // Wait for Google Maps before loading Flutter bootstrap
      waitForGoogleMaps(function() {
        console.log('âœ… Google Maps API ready, loading Flutter bootstrap');
        loadFlutterBootstrap();
      });
      
      // Fallback: Load Flutter after 5 seconds even if Google Maps isn't ready
      setTimeout(function() {
        if (!flutterLoaded) {
          console.warn('âš ï¸ Google Maps API not ready after 5 seconds, loading Flutter anyway');
          loadFlutterBootstrap();
        }
      }, 5000);
      
      // Handle Google Sign-In redirect
      if (window.location.hash.includes('access_token') || window.location.search.includes('code')) {
        console.log('Google Sign-In redirect detected');
        // The Flutter app will handle the redirect
      }
      
      
      // Wait for Flutter to be ready
      window.addEventListener('flutter-first-frame', function() {
        console.log('Flutter first frame rendered');
      });
    });
    
    // ×¤×•× ×§×¦×™×” ×œ× ×™×§×•×™ Google Sign-In ××”×“×¤×“×¤×Ÿ
    window.clearGoogleSignIn = function() {
      try {
        console.log('ğŸ§¹ Starting Google Sign-In cleanup...');
        
        // × ×™×§×•×™ localStorage
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && (key.includes('google') || key.includes('gapi') || key.includes('oauth') || key.includes('firebase'))) {
            keysToRemove.push(key);
          }
        }
        keysToRemove.forEach(key => {
          localStorage.removeItem(key);
          console.log('ğŸ—‘ï¸ Removed from localStorage:', key);
        });
        
        // × ×™×§×•×™ sessionStorage
        const sessionKeysToRemove = [];
        for (let i = 0; i < sessionStorage.length; i++) {
          const key = sessionStorage.key(i);
          if (key && (key.includes('google') || key.includes('gapi') || key.includes('oauth') || key.includes('firebase'))) {
            sessionKeysToRemove.push(key);
          }
        }
        sessionKeysToRemove.forEach(key => {
          sessionStorage.removeItem(key);
          console.log('ğŸ—‘ï¸ Removed from sessionStorage:', key);
        });
        
        // × ×™×§×•×™ cookies (×× ××¤×©×¨)
        try {
          document.cookie.split(";").forEach(function(c) { 
            if (c.includes('google') || c.includes('gapi') || c.includes('oauth')) {
              document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
            }
          });
        } catch (e) {
          console.warn('âš ï¸ Could not clear cookies:', e);
        }
        
        console.log('âœ… Google Sign-In data cleared from browser storage');
      } catch (e) {
        console.warn('âš ï¸ Error clearing Google Sign-In data:', e);
      }
    };
  </script>
</head>
<body>
  <!-- Flutter bootstrap will be loaded after Google Maps API is ready -->
</body>
</html>
